name: "Deploy to prod"

on:
    push:
        branches:
            - "main"
        tags:
            - "v*"

jobs:
    build-docker-image-for-prod:
        permissions:
            contents: read
            packages: write
        uses: ./.github/workflows/build-and-push-docker-image.yml 

    deploy-to-prod:
        needs: build-docker-image-for-prod
        uses: ./.github/workflows/deploy.yml
        with:
            target-namespace: ${{ vars.PROD_NAMESPACE }}
            ingress-host: eventhub.backend.prod
        secrets:
            kubeconfig: ${{ secrets.KUBECONFIG }}
            postgresPassword: ${{ secrets.PROD_POSTGRES_PASSWORD }}
            userPassword: ${{ secrets.PROD_USER_PASSWORD }}